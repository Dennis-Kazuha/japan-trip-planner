<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FEARLESS TRIP | æ—¥æœ¬æ—…éŠè¦åŠƒèˆ‡éµè·¯ç³»çµ±</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Vue 3 CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <!-- FontAwesome Icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
  />

  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter",
        sans-serif;
    }

    /* éš±è—åŸç”Ÿæ»¾å‹•æ¢ï¼Œä½†ä¿ç•™æ»¾å‹•åŠŸèƒ½ */
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    /* ä¸»é¡Œè‰² */
    .app-primary {
      background-color: #f7004f;
    }
    .app-secondary {
      background: radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%);
    }
    .app-text-primary {
      color: #f7004f;
    }
    .app-bg {
      background-color: #f4f4f5;
    }

    /* æ¨¡æ“¬æ‰‹æ©Ÿé ‚éƒ¨ç‹€æ…‹æ¬„ */
    .status-bar {
      height: 22px;
      background: linear-gradient(
        to right,
        rgba(15, 23, 42, 0.95),
        rgba(15, 23, 42, 0.8)
      );
    }
  </style>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#f7004f',
            secondary: '#020617',
            background: '#f4f4f5',
          },
        },
      },
    };
  </script>
</head>

<body class="min-h-screen bg-gradient-to-br from-zinc-900 via-zinc-800 to-zinc-900">
  <div
    id="app"
    class="max-w-md mx-auto bg-white min-h-screen flex flex-col rounded-3xl shadow-2xl overflow-hidden"
  >
    <!-- ç‹€æ…‹åˆ— -->
    <div class="status-bar"></div>

    <!-- Hero / Logo å€ï¼ˆå«æµ®æ°´å°ï¼‰ -->
    <div
      class="app-secondary text-white px-6 pt-6 pb-8 shadow-lg relative overflow-hidden"
    >
      <!-- æµ®æ°´å° -->
      <div
        class="absolute inset-0 flex items-center justify-center opacity-20 pointer-events-none"
      >
        <!-- æŠŠ logo åœ–æª”å­˜æˆ logo.png æ”¾åœ¨åŒè³‡æ–™å¤¾ -->
        <img
          src="logo.png"
          alt="LE SSERAFIM Logo"
          class="w-64 max-w-[80%] object-contain drop-shadow-[0_0_24px_rgba(0,0,0,0.8)]"
        />
      </div>

      <!-- å‰æ™¯å…§å®¹ -->
      <div class="relative text-center space-y-2">
        <h1
          class="text-3xl font-extrabold tracking-[0.35em] uppercase mb-1 drop-shadow"
        >
          FEARLESS TRIP
        </h1>
        <p
          class="text-xs font-light tracking-[0.22em] opacity-80 uppercase mb-3"
        >
          Japan Travel Planner
        </p>

        <div
          class="flex justify-center space-x-4 text-primary text-xl drop-shadow"
        >
          <i class="fas fa-route"></i>
          <i class="fas fa-cloud-sun"></i>
          <i class="fas fa-wallet"></i>
          <i class="fas fa-train"></i>
        </div>
      </div>
    </div>

    <!-- Tab åˆ‡æ› -->
    <header
      class="sticky top-0 z-20 bg-white/90 backdrop-blur p-3 border-b border-gray-200"
    >
      <div
        class="flex justify-around p-1 bg-gray-100 rounded-2xl shadow-inner gap-1"
      >
        <button
          v-for="tab in tabs"
          :key="tab.id"
          @click="currentTab = tab.id"
          :class="[
            'relative flex-1 py-2 rounded-xl font-medium transition-all duration-300 flex items-center justify-center space-x-1',
            currentTab === tab.id
              ? 'bg-primary text-white shadow-lg'
              : 'text-gray-600 hover:bg-white'
          ]"
        >
          <i :class="tab.icon"></i>
          <span class="text-xs sm:text-sm">{{ tab.name }}</span>
          <span
            v-if="currentTab === tab.id"
            class="absolute -bottom-1 left-4 right-4 h-0.5 bg-white/80 rounded-full"
          ></span>
        </button>
      </div>
    </header>

    <!-- å…§å®¹å€åŸŸ -->
    <main class="flex-grow p-4 overflow-y-auto no-scrollbar app-bg">
      <!-- 1. è¡Œç¨‹è¡¨ -->
      <section v-if="currentTab === 'itinerary'" class="space-y-6">
        <h2
          class="flex items-center justify-between text-2xl font-bold app-text-primary border-b pb-2"
        >
          <span>ğŸ“… æ¯æ—¥è¡Œç¨‹è¦åŠƒ</span>
          <span
            class="text-[10px] px-2 py-1 rounded-full bg-primary/10 text-primary font-semibold tracking-wide uppercase"
          >
            Day 1 â€§ é—œè¥¿
          </span>
        </h2>

        <!-- æ–°å¢è¡Œç¨‹è¡¨å–® -->
        <form
          @submit.prevent="addActivity"
          class="bg-white p-4 shadow-xl rounded-2xl border border-primary/10 space-y-3"
        >
          <div class="flex gap-2">
            <input
              v-model="newActivity.time"
              type="time"
              required
              class="w-24 p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary text-center text-sm"
            />
            <input
              v-model="newActivity.location"
              type="text"
              placeholder="åœ°é» (å¦‚ï¼šæ±äº¬éµå¡”)"
              required
              class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary text-sm"
            />
          </div>
          <textarea
            v-model="newActivity.details"
            placeholder="å‚™è¨» (å¦‚ï¼šé–€ç¥¨å·²è³¼è²·)"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary resize-none text-sm"
            rows="2"
          ></textarea>
          <button
            type="submit"
            class="app-primary text-white w-full py-3 rounded-xl font-semibold shadow-md hover:shadow-lg transition duration-200 text-sm"
          >
            <i class="fas fa-plus mr-2"></i> æ–°å¢æ´»å‹•
          </button>
        </form>

        <!-- è¡Œç¨‹åˆ—è¡¨ -->
        <div
          v-if="sortedSchedule.length === 0"
          class="text-center p-8 bg-white rounded-2xl shadow-md text-gray-500"
        >
          <i class="far fa-calendar-alt text-4xl mb-3 app-text-primary"></i>
          <p>é‚„æ²’æœ‰è¡Œç¨‹ï¼Œç„¡ç•åœ°æ–°å¢ä½ çš„æ—…ç¨‹å§ï¼</p>
        </div>

        <div v-else class="space-y-4">
          <div
            v-for="(activity, index) in sortedSchedule"
            :key="activity.id"
            class="relative pl-7"
          >
            <!-- æ™‚é–“ç·šé» -->
            <div
              class="absolute left-0 top-1.5 w-3 h-3 app-primary rounded-full ring-4 ring-primary/30"
            ></div>

            <!-- é€£æ¥ç·šï¼ˆä¸ç•«åˆ°æœ€å¾Œä¸€å€‹ï¼‰ -->
            <div
              v-if="index < sortedSchedule.length - 1"
              class="absolute left-[6px] top-4 bottom-[-10px] w-0.5 bg-primary/40"
            ></div>

            <div
              :class="[
                'bg-white p-4 rounded-xl shadow-md transition-all duration-300 border',
                activity.editing
                  ? 'bg-red-50/70 border-primary/40'
                  : 'border-transparent hover:border-primary/30'
              ]"
            >
              <!-- æª¢è¦–æ¨¡å¼ -->
              <div
                v-if="!activity.editing"
                @click="toggleEdit(activity)"
                class="cursor-pointer"
              >
                <p class="font-bold text-lg app-text-primary">
                  {{ activity.time }}
                </p>
                <h3 class="font-semibold text-gray-800 text-base">
                  {{ activity.location }}
                </h3>
                <p
                  v-if="activity.details"
                  class="text-xs text-gray-600 mt-1 italic"
                >
                  {{ activity.details }}
                </p>
                <div class="mt-2 text-right space-x-2">
                  <button
                    @click.stop="deleteActivity(activity.id)"
                    class="text-red-500 hover:text-red-700 px-2 py-1 rounded text-xs"
                  >
                    <i class="fas fa-trash-alt mr-1"></i>åˆªé™¤
                  </button>
                  <button
                    @click.stop="toggleEdit(activity)"
                    class="text-secondary hover:text-secondary/80 px-2 py-1 rounded text-xs"
                  >
                    <i class="fas fa-edit mr-1"></i>ç·¨è¼¯
                  </button>
                </div>
              </div>

              <!-- ç·¨è¼¯æ¨¡å¼ -->
              <div v-else class="space-y-2">
                <div class="flex gap-2">
                  <input
                    v-model="activity.time"
                    type="time"
                    class="w-24 p-2 border rounded-lg focus:ring-primary focus:border-primary text-sm text-center"
                  />
                  <input
                    v-model="activity.location"
                    type="text"
                    class="flex-1 p-2 border rounded-lg focus:ring-primary focus:border-primary text-sm"
                  />
                </div>
                <textarea
                  v-model="activity.details"
                  class="w-full p-2 border rounded-lg resize-none focus:ring-primary focus:border-primary text-sm"
                  rows="2"
                ></textarea>
                <button
                  @click="toggleEdit(activity)"
                  class="app-primary text-white w-full py-2 rounded-lg font-medium text-sm"
                >
                  <i class="fas fa-check mr-1"></i> å®Œæˆç·¨è¼¯
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- 2. åˆ†å¸³ç³»çµ± -->
      <section v-else-if="currentTab === 'expenses'" class="space-y-6">
        <h2
          class="text-2xl font-bold app-text-primary border-b pb-2 flex items-center justify-between"
        >
          <span>ğŸ’° æ—…éŠåˆ†å¸³çµç®—</span>
          <span
            class="text-[10px] px-2 py-1 rounded-full bg-primary/10 text-primary font-semibold tracking-wide"
          >
            JPY
          </span>
        </h2>

        <!-- æ—…ä¼´åˆ—è¡¨ -->
        <div
          class="bg-white p-4 shadow-xl rounded-2xl border border-primary/10 space-y-4"
        >
          <h3
            class="font-semibold text-lg text-gray-700 border-b pb-2 flex items-center justify-between"
          >
            <span>æ—…ä¼´åå–®</span>
            <span class="text-xs text-gray-400"
              >å…± {{ people.length }} äºº</span
            >
          </h3>
          <div class="flex flex-wrap gap-2 mb-2">
            <span
              v-for="person in people"
              :key="person"
              class="bg-secondary/10 text-secondary font-medium py-1 px-3 rounded-full flex items-center shadow-sm text-xs"
            >
              {{ person }}
              <button
                @click="removePerson(person)"
                class="ml-2 text-[11px] text-secondary/70 hover:text-secondary transition"
              >
                <i class="fas fa-times-circle"></i>
              </button>
            </span>
          </div>
          <div class="flex space-x-2">
            <input
              v-model="newPersonName"
              @keyup.enter="addPerson"
              type="text"
              placeholder="æ–°å¢æ—…ä¼´åç¨±"
              class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary text-sm"
            />
            <button
              @click="addPerson"
              class="app-secondary text-white px-3 rounded-lg font-semibold shadow-md text-sm"
            >
              <i class="fas fa-user-plus"></i>
            </button>
          </div>
        </div>

        <!-- æ–°å¢æ”¯å‡º -->
        <form
          @submit.prevent="addExpense"
          class="bg-white p-4 shadow-xl rounded-2xl border border-primary/10 space-y-3"
        >
          <h3
            class="font-semibold text-lg text-gray-700 border-b pb-2 flex items-center justify-between"
          >
            <span>è¨˜éŒ„æ–°æ”¯å‡º (JPY)</span>
          </h3>
          <input
            v-model.number="newExpense.amount"
            type="number"
            placeholder="é‡‘é¡ (JPY)"
            required
            min="1"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary text-sm"
          />
          <input
            v-model="newExpense.description"
            type="text"
            placeholder="æ”¯å‡ºé …ç›® (å¦‚ï¼šåˆé¤ã€ä¼´æ‰‹ç¦®)"
            required
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary text-sm"
          />
          <select
            v-model="newExpense.paidBy"
            required
            class="w-full p-3 border border-gray-300 rounded-lg bg-white focus:ring-primary focus:border-primary text-sm"
          >
            <option value="" disabled>èª°ä»˜çš„éŒ¢ï¼Ÿ</option>
            <option v-for="person in people" :key="person" :value="person">
              {{ person }}
            </option>
          </select>

          <p class="font-medium text-gray-700 mt-3 text-sm">
            èª°åƒèˆ‡äº†é€™ç­†åˆ†å¸³ï¼Ÿ
          </p>
          <div class="flex flex-wrap gap-3">
            <label
              v-for="person in people"
              :key="person"
              class="inline-flex items-center bg-gray-100 p-2 rounded-lg shadow-inner text-xs"
            >
              <input
                type="checkbox"
                :value="person"
                v-model="newExpense.participants"
                class="form-checkbox text-primary rounded focus:ring-primary mr-2"
              />
              <span class="text-gray-700">{{ person }}</span>
            </label>
          </div>
          <button
            type="submit"
            :disabled="people.length < 2 || newExpense.participants.length === 0"
            class="app-primary text-white w-full py-3 rounded-xl font-semibold shadow-md hover:shadow-lg transition duration-200 disabled:opacity-50 text-sm"
          >
            <i class="fas fa-credit-card mr-2"></i> è¨˜éŒ„æ”¯å‡º
          </button>
        </form>

        <!-- ç¸½è¦½å¡ç‰‡ -->
        <div class="grid grid-cols-2 gap-3">
          <div
            class="bg-white p-3 rounded-xl shadow-inner text-center border border-primary/10"
          >
            <p class="text-xs text-gray-500">ç›®å‰ç¸½æ”¯å‡º</p>
            <p class="text-xl font-bold text-secondary mt-1">
              {{ totalExpense.toLocaleString() }} JPY
            </p>
          </div>
          <div
            class="bg-white p-3 rounded-xl shadow-inner text-center border border-primary/10"
          >
            <p class="text-xs text-gray-500">å¹³å‡æ¯äºº</p>
            <p class="text-xl font-bold text-secondary mt-1">
              {{ averageExpensePerPerson.toLocaleString() }} JPY
            </p>
          </div>
        </div>

        <!-- çµç®—çµæœ -->
        <div class="bg-secondary text-white p-4 shadow-xl rounded-2xl mt-3">
          <h3
            class="font-bold text-xl mb-3 flex justify-between items-center border-b border-white/30 pb-2"
          >
            <span>çµç®—çµæœ</span>
            <i class="fas fa-handshake text-2xl app-text-primary"></i>
          </h3>
          <div
            v-if="settlements.length === 0"
            class="text-center text-white/80 p-4 text-sm"
          >
            <p>æ–°å¢å¹¾ç­†æ”¯å‡ºä¹‹å¾Œï¼Œé€™è£¡æœƒè‡ªå‹•ç”¢ç”Ÿæœ€ç°¡çµç®—æ–¹æ¡ˆã€‚</p>
          </div>
          <div v-else class="space-y-2">
            <div
              v-for="(settlement, index) in settlements"
              :key="index"
              class="bg-white text-gray-800 p-3 rounded-lg flex justify-between items-center shadow-inner border border-emerald-100 text-sm"
            >
              <span class="font-medium">
                <span class="text-red-500 font-semibold">
                  {{ settlement.from }}
                </span>
                <i
                  class="fas fa-long-arrow-alt-right mx-2 app-text-primary"
                ></i>
                <span class="text-emerald-600 font-semibold">
                  {{ settlement.to }}
                </span>
              </span>
              <span class="font-bold text-lg text-emerald-700">
                {{ settlement.amount.toLocaleString() }}
              </span>
            </div>
          </div>
        </div>
      </section>

      <!-- 3. éµè·¯ç³»çµ± -->
      <section v-else-if="currentTab === 'railway'" class="space-y-6">
        <h2 class="text-2xl font-bold app-text-primary border-b pb-2">
          ğŸš„ æ—¥æœ¬éµè·¯/äº¤é€šæŸ¥è©¢
        </h2>

        <div
          class="bg-white p-4 shadow-xl rounded-2xl border border-primary/10 space-y-3"
        >
          <p class="font-medium text-gray-700 text-sm">
            æŸ¥è©¢è½‰ä¹˜æ™‚é–“èˆ‡é ä¼°ç¥¨åƒ¹ï¼š
          </p>
          <input
            v-model="railwayOrigin"
            type="text"
            placeholder="èµ·é» (å¦‚ï¼šæ±äº¬ç«™)"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary text-sm"
          />
          <input
            v-model="railwayDestination"
            type="text"
            placeholder="çµ‚é» (å¦‚ï¼šæ–°å¤§é˜ªç«™)"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary text-sm"
          />
          <button
            @click="searchRailway"
            :disabled="isLoadingRailway"
            class="app-primary text-white w-full py-3 rounded-xl font-semibold shadow-md hover:shadow-lg transition duration-200 disabled:opacity-50 text-sm"
          >
            <i
              v-if="!isLoadingRailway"
              class="fas fa-search-location mr-2"
            ></i>
            <i v-else class="fas fa-spinner animate-spin mr-2"></i>
            æŸ¥è©¢è·¯ç·š
          </button>
        </div>

        <!-- éµè·¯çµæœ -->
        <div
          v-if="railwayResults.time || isLoadingRailway"
          class="mt-2 bg-white p-6 rounded-2xl shadow-xl border border-primary/10"
        >
          <div
            v-if="isLoadingRailway"
            class="text-center p-8 text-primary font-medium space-y-2"
          >
            <i class="fas fa-train fa-beat-fade text-3xl mb-1"></i>
            <p>æ­£åœ¨æŸ¥è©¢æœ€ä½³è½‰ä¹˜æ–¹æ¡ˆä¸­...</p>
            <p class="text-xs text-gray-500">
              ä¾ç…§ç¶²è·¯ç‹€æ³ï¼Œå¤§ç´„éœ€è¦å¹¾ç§’é˜ã€‚
            </p>
          </div>

          <div v-else-if="railwayResults.time">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
              <h3
                class="text-lg font-bold text-gray-800 flex-1 leading-snug"
              >
                {{ railwayOrigin }}
                <i class="fas fa-arrow-right mx-2 app-text-primary"></i>
                {{ railwayDestination }}
              </h3>
            </div>

            <div class="grid grid-cols-3 gap-4 text-center text-sm">
              <div class="p-2 bg-background rounded-lg shadow-inner">
                <i class="fas fa-clock text-xl app-text-primary mb-1"></i>
                <p class="text-xs text-gray-500">ç¸½æ™‚é–“</p>
                <p class="font-bold text-secondary">
                  {{ railwayResults.time }}
                </p>
              </div>
              <div class="p-2 bg-background rounded-lg shadow-inner">
                <i class="fas fa-yen-sign text-xl app-text-primary mb-1"></i>
                <p class="text-xs text-gray-500">ç¥¨åƒ¹ (é ä¼°)</p>
                <p class="font-bold text-secondary">
                  {{ railwayResults.fare !== null ? railwayResults.fare.toLocaleString() + ' JPY' : 'â€”' }}
                </p>
              </div>
              <div class="p-2 bg-background rounded-lg shadow-inner">
                <i
                  class="fas fa-exchange-alt text-xl app-text-primary mb-1"
                ></i>
                <p class="text-xs text-gray-500">è½‰ä¹˜æ¬¡æ•¸</p>
                <p class="font-bold text-secondary">
                  {{ railwayResults.transfers }}
                </p>
              </div>
            </div>

            <p
              class="text-xs text-gray-600 mt-4 italic border-t pt-2 flex items-start gap-1"
            >
              <i class="fas fa-lightbulb app-text-primary mt-0.5"></i>
              <span
                >æç¤ºï¼šæ­¤ç‚ºæ¨¡æ“¬é ä¼°å€¼ï¼Œå¯¦éš›ç­æ¬¡èˆ‡ç¥¨åƒ¹è«‹ä»¥å®˜æ–¹å³æ™‚è³‡è¨Šç‚ºä¸»ã€‚</span
              >
            </p>
            <button
              @click="openTransitMap"
              class="w-full mt-4 bg-secondary text-white py-3 rounded-xl font-semibold shadow-md hover:shadow-lg transition duration-200 text-sm"
            >
              <i class="fas fa-map-pin mr-2"></i> åœ¨ Google Maps æŸ¥çœ‹å³æ™‚äº¤é€š
            </button>
          </div>
        </div>

        <div
          v-else
          class="text-center p-8 bg-white rounded-2xl shadow-md text-gray-500 text-sm"
        >
          <i class="fas fa-map-signs text-4xl mb-3 app-text-primary"></i>
          <p>è¼¸å…¥èµ·é»èˆ‡çµ‚é»ï¼ŒæŸ¥è©¢ä½ çš„æ—¥æœ¬éµè·¯æ—…ç¨‹ã€‚</p>
        </div>
      </section>

      <!-- 4. å¤©æ°£ -->
      <section v-else-if="currentTab === 'weather'" class="space-y-6">
        <h2 class="text-2xl font-bold app-text-primary border-b pb-2">
          â˜€ï¸ ç•¶åœ°å¤©æ°£æŸ¥è©¢
        </h2>

        <div
          class="bg-white p-4 shadow-xl rounded-2xl border border-primary/10 space-y-3"
        >
          <p class="font-medium text-gray-700 text-sm">
            è«‹è¼¸å…¥æ—¥æœ¬åŸå¸‚åç¨±ï¼š
          </p>
          <div class="flex space-x-2">
            <input
              v-model="weatherQuery"
              @keyup.enter="getWeather"
              type="text"
              placeholder="ä¾‹å¦‚ï¼šæ±äº¬, å¤§é˜ª, äº¬éƒ½"
              class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary text-sm"
            />
            <button
              @click="getWeather"
              :disabled="isLoadingWeather"
              class="app-primary text-white px-3 rounded-lg font-semibold shadow-md hover:shadow-lg transition duration-200 disabled:opacity-50 text-sm"
            >
              <i v-if="!isLoadingWeather" class="fas fa-search"></i>
              <i v-else class="fas fa-spinner animate-spin"></i>
            </button>
          </div>
        </div>

        <div
          v-if="weatherResult.city || isLoadingWeather"
          class="mt-2 bg-white p-6 rounded-2xl shadow-xl border border-primary/10"
        >
          <div
            v-if="isLoadingWeather"
            class="text-center p-8 text-primary font-medium space-y-2"
          >
            <i class="fas fa-sun fa-spin text-3xl mb-1"></i>
            <p>æ­£åœ¨æŸ¥è©¢å¤©æ°£è³‡è¨Šä¸­...</p>
            <p class="text-xs text-gray-500">
              å¦‚æœç¶²è·¯è¼ƒæ…¢ï¼Œå¯èƒ½éœ€è¦ä¸€é»æ™‚é–“ã€‚
            </p>
          </div>

          <div v-else-if="weatherResult.city">
            <div
              class="flex justify-between items-center mb-4 border-b pb-2 text-sm"
            >
              <h3 class="text-2xl font-bold text-gray-800">
                {{ weatherResult.city }}
              </h3>
              <p class="text-xs text-gray-500">{{ weatherResult.date }}</p>
            </div>

            <div class="flex items-center justify-start space-x-6">
              <div class="text-5xl app-text-primary">
                <i :class="weatherResult.iconClass"></i>
              </div>
              <div>
                <p class="text-4xl font-extrabold text-gray-900">
                  {{ weatherResult.temperature }}Â°C
                </p>
                <p class="text-lg font-medium text-gray-600">
                  {{ weatherResult.description }}
                </p>
              </div>
            </div>

            <div class="grid grid-cols-3 gap-4 mt-6 pt-4 border-t text-sm">
              <div class="text-center p-2 bg-background rounded-lg shadow-inner">
                <p class="text-[11px] text-gray-500">æ¿•åº¦</p>
                <p class="font-bold text-secondary text-lg">
                  {{ weatherResult.humidity }}%
                </p>
              </div>
              <div class="text-center p-2 bg-background rounded-lg shadow-inner">
                <p class="text-[11px] text-gray-500">é¢¨é€Ÿ</p>
                <p class="font-bold text-secondary text-lg">
                  {{ weatherResult.windSpeed }} km/h
                </p>
              </div>
              <div class="text-center p-2 bg-background rounded-lg shadow-inner">
                <p class="text-[11px] text-gray-500">é«˜/ä½æº«</p>
                <p class="font-bold text-secondary text-lg">
                  {{ weatherResult.maxTemp }}/{{ weatherResult.minTemp }}Â°C
                </p>
              </div>
            </div>
          </div>
        </div>

        <div
          v-else
          class="text-center p-8 bg-white rounded-2xl shadow-md text-gray-500 text-sm"
        >
          <i class="fas fa-cloud text-4xl mb-3 app-text-primary"></i>
          <p>è«‹è¼¸å…¥åœ°é»é€²è¡ŒæŸ¥è©¢ã€‚</p>
        </div>
      </section>

      <!-- 5. åœ°åœ–èˆ‡å°èˆª -->
      <section v-else-if="currentTab === 'map'" class="space-y-6">
        <h2 class="text-2xl font-bold app-text-primary border-b pb-2">
          ğŸ—ºï¸ åœ°åœ–èˆ‡å°èˆª
        </h2>

        <div
          class="bg-white p-4 shadow-xl rounded-2xl border border-primary/10 space-y-3"
        >
          <p class="font-medium text-gray-700 text-sm">
            æœå°‹åœ°é»ä¸¦é–‹å•Ÿ Google Maps å°èˆªï¼š
          </p>
          <div class="flex space-x-2">
            <input
              v-model="mapQuery"
              @keyup.enter="openMap"
              type="text"
              placeholder="è¼¸å…¥åœ°é» (å¦‚ï¼šæ¾€è°·äº¤å‰è·¯å£)"
              class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary text-sm"
            />
            <button
              @click="openMap"
              class="app-primary text-white px-3 rounded-lg font-semibold shadow-md hover:shadow-lg transition duration-200 text-sm"
            >
              <i class="fas fa-location-arrow"></i>
            </button>
          </div>
          <p class="text-xs text-gray-500 italic mt-2 flex items-start gap-1">
            <i class="fas fa-info-circle app-text-primary mt-0.5"></i>
            <span>é»æ“ŠæŒ‰éˆ•å°‡åœ¨æ–°è¦–çª—ä¸­é–‹å•Ÿ Google Mapsã€‚</span>
          </p>

          <!-- å¸¸ç”¨åœ°é»æ·å¾‘ -->
          <div class="flex flex-wrap gap-2 mt-2">
            <button
              v-for="preset in mapPresets"
              :key="preset"
              @click="mapQuery = preset; openMap();"
              class="px-3 py-1 text-[11px] rounded-full bg-gray-100 text-gray-700 hover:bg-primary hover:text-white transition"
            >
              {{ preset }}
            </button>
          </div>
        </div>

        <!-- åœ°æ¨™é è¦½ -->
        <div
          class="mt-2 bg-white p-4 rounded-2xl shadow-xl text-center border border-primary/10"
        >
          <h3 class="font-bold text-xl app-text-primary mb-3">
            ğŸ“ æ—¥æœ¬åœ°æ¨™é è¦½
          </h3>
          <img
            src="https://placehold.co/400x200/f7004f/ffffff?text=I%27m+FEARLESS"
            alt="LE SSERAFIM é¢¨æ ¼å°é¢åœ–ç‰‡"
            class="w-full h-auto rounded-lg shadow-md object-cover"
          />
          <p class="text-xs text-gray-600 mt-2">
            é è¦½åœ–åƒ…ä¾›ç¤ºæ„ï¼Œå¯¦éš›å°èˆªè«‹ä½¿ç”¨ä¸Šæ–¹æœå°‹åŠŸèƒ½ã€‚
          </p>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer
      class="p-3 text-center text-[11px] text-gray-500 border-t mt-4 sticky bottom-0 bg-white/90 shadow-inner"
    >
      Â© 2024 FEARLESS TRIP Planner Â· Made with â¤ for Japan & LE SSERAFIM
    </footer>
  </div>

  <script>
    const { createApp, ref, reactive, computed, watch } = Vue;

    createApp({
      setup() {
        const currentTab = ref("itinerary");
        const tabs = [
          { id: "itinerary", name: "è¡Œç¨‹è¡¨", icon: "fas fa-route" },
          { id: "expenses", name: "åˆ†å¸³", icon: "fas fa-hand-holding-usd" },
          { id: "railway", name: "éµè·¯ç³»çµ±", icon: "fas fa-train" },
          { id: "weather", name: "å¤©æ°£", icon: "fas fa-cloud-sun" },
          { id: "map", name: "åœ°åœ–", icon: "fas fa-map-marked-alt" },
        ];

        const STORAGE_KEYS = {
          schedule: "fearless_schedule_v1",
          people: "fearless_people_v1",
          expenses: "fearless_expenses_v1",
        };

        const safeLoad = (key, fallback) => {
          try {
            const raw = localStorage.getItem(key);
            if (!raw) return fallback;
            const parsed = JSON.parse(raw);
            return parsed ?? fallback;
          } catch (e) {
            return fallback;
          }
        };

        // ----- è¡Œç¨‹è¡¨ -----
        let activityIdCounter = 0;
        const defaultSchedule = [
          {
            id: ++activityIdCounter,
            time: "08:00",
            location: "æŠµé”é—œè¥¿æ©Ÿå ´ (KIX)",
            details: "æº–å‚™æ­ä¹˜ JR Haruka å‰å¾€äº¬éƒ½",
          },
          {
            id: ++activityIdCounter,
            time: "12:00",
            location: "å…¥ä½äº¬éƒ½é£¯åº—",
            details: "æ–¼å››æ¢æ²³åŸç”ºå€åŸŸè¾¦ç†å…¥ä½",
          },
          {
            id: ++activityIdCounter,
            time: "14:00",
            location: "æ¸…æ°´å¯º",
            details: "åƒè§€æ¸…æ°´èˆå°èˆ‡éŸ³ç¾½ç€‘å¸ƒ",
          },
        ];

        const loadedSchedule = safeLoad(STORAGE_KEYS.schedule, null);
        if (Array.isArray(loadedSchedule)) {
          loadedSchedule.forEach((a) => {
            if (typeof a.id === "number" && a.id > activityIdCounter) {
              activityIdCounter = a.id;
            }
          });
        }

        const initialSchedule =
          Array.isArray(loadedSchedule) && loadedSchedule.length
            ? loadedSchedule
            : defaultSchedule;

        const dailySchedule = reactive(
          initialSchedule.map((a) => ({
            ...a,
            editing: false,
          }))
        );

        const newActivity = reactive({
          time: "09:00",
          location: "",
          details: "",
        });

        const sortedSchedule = computed(() => {
          return [...dailySchedule].sort((a, b) =>
            String(a.time).localeCompare(String(b.time))
          );
        });

        const addActivity = () => {
          if (!newActivity.location.trim()) return;
          dailySchedule.push({
            id: ++activityIdCounter,
            time: newActivity.time || "09:00",
            location: newActivity.location.trim(),
            details: newActivity.details.trim(),
            editing: false,
          });
          newActivity.time = "09:00";
          newActivity.location = "";
          newActivity.details = "";
        };

        const deleteActivity = (id) => {
          const index = dailySchedule.findIndex((item) => item.id === id);
          if (index !== -1) {
            dailySchedule.splice(index, 1);
          }
        };

        const toggleEdit = (activity) => {
          activity.editing = !activity.editing;
        };

        // å­˜è¡Œç¨‹åˆ° localStorageï¼ˆä¸å­˜ editing ç‹€æ…‹ï¼‰
        watch(
          dailySchedule,
          (val) => {
            const toSave = val.map(({ editing, ...rest }) => rest);
            localStorage.setItem(
              STORAGE_KEYS.schedule,
              JSON.stringify(toSave)
            );
          },
          { deep: true }
        );

        // ----- åˆ†å¸³ç³»çµ± -----
        const defaultPeople = ["é‡‡æº", "å’²è‰¯", "æ©æ¡"];
        const people = ref(safeLoad(STORAGE_KEYS.people, defaultPeople));

        const defaultExpenses = [
          {
            description: "æ©Ÿå ´è»Šç¥¨",
            amount: 5000,
            paidBy: "é‡‡æº",
            participants: ["é‡‡æº", "å’²è‰¯"],
          },
          {
            description: "æ™šé¤å£½å¸",
            amount: 8400,
            paidBy: "å’²è‰¯",
            participants: ["é‡‡æº", "å’²è‰¯", "æ©æ¡"],
          },
        ];
        const expensesArray = safeLoad(
          STORAGE_KEYS.expenses,
          defaultExpenses
        );
        const expenses = reactive(expensesArray);

        const newExpense = reactive({
          description: "",
          amount: null,
          paidBy: "",
          participants: [],
        });

        const addPerson = () => {
          const name = newPersonName.value.trim();
          if (name && !people.value.includes(name)) {
            people.value.push(name);
            newPersonName.value = "";
          }
        };

        const newPersonName = ref("");

        const removePerson = (name) => {
          people.value = people.value.filter((p) => p !== name);
          expenses.forEach((expense) => {
            expense.participants = expense.participants.filter(
              (p) => p !== name
            );
            if (expense.paidBy === name) {
              expense.paidBy = people.value[0] || "";
            }
          });
        };

        const addExpense = () => {
          if (
            !(newExpense.amount > 0) ||
            !newExpense.description.trim() ||
            !newExpense.paidBy ||
            newExpense.participants.length === 0
          )
            return;

          expenses.push({
            description: newExpense.description.trim(),
            amount: Number(newExpense.amount),
            paidBy: newExpense.paidBy,
            participants: [...newExpense.participants],
          });

          Object.assign(newExpense, {
            description: "",
            amount: null,
            paidBy: "",
            participants: [],
          });
        };

        const settlements = computed(() => {
          const balances = {};
          people.value.forEach((p) => (balances[p] = 0));

          expenses.forEach((expense) => {
            const costPerPerson =
              expense.amount / expense.participants.length;
            if (balances[expense.paidBy] !== undefined) {
              balances[expense.paidBy] += expense.amount;
            }
            expense.participants.forEach((person) => {
              if (balances[person] !== undefined) {
                balances[person] -= costPerPerson;
              }
            });
          });

          Object.keys(balances).forEach((person) => {
            balances[person] = Math.round(balances[person]);
          });

          const debtors = [];
          const creditors = [];
          const result = [];

          Object.entries(balances).forEach(([person, amount]) => {
            if (amount < 0) debtors.push({ name: person, amount: -amount });
            else if (amount > 0) creditors.push({ name: person, amount });
          });

          let dIndex = 0;
          let cIndex = 0;

          while (dIndex < debtors.length && cIndex < creditors.length) {
            const debtor = debtors[dIndex];
            const creditor = creditors[cIndex];
            const amountToSettle = Math.min(
              debtor.amount,
              creditor.amount
            );

            if (amountToSettle > 0) {
              result.push({
                from: debtor.name,
                to: creditor.name,
                amount: amountToSettle,
              });
            }

            debtor.amount -= amountToSettle;
            creditor.amount -= amountToSettle;

            if (debtor.amount <= 1) dIndex++;
            if (creditor.amount <= 1) cIndex++;
          }

          return result;
        });

        const totalExpense = computed(() =>
          expenses.reduce((sum, e) => sum + (e.amount || 0), 0)
        );

        const averageExpensePerPerson = computed(() => {
          if (!people.value.length) return 0;
          return Math.round(totalExpense.value / people.value.length);
        });

        // å­˜ people / expenses åˆ° localStorage
        watch(
          people,
          (val) => {
            localStorage.setItem(
              STORAGE_KEYS.people,
              JSON.stringify(val)
            );
          },
          { deep: true }
        );

        watch(
          expenses,
          (val) => {
            localStorage.setItem(
              STORAGE_KEYS.expenses,
              JSON.stringify(val)
            );
          },
          { deep: true }
        );

        // ----- éµè·¯ -----
        const railwayOrigin = ref("æ±äº¬ç«™");
        const railwayDestination = ref("æ–°å¤§é˜ªç«™");
        const isLoadingRailway = ref(false);
        const railwayResults = reactive({
          time: "",
          fare: 0,
          transfers: 0,
        });

        const searchRailway = async () => {
  const origin = railwayOrigin.value.trim();
  const destination = railwayDestination.value.trim();
  if (!origin || !destination) return;

  isLoadingRailway.value = true;
  Object.assign(railwayResults, { time: '', fare: 0, transfers: 0 });

  try {
    const url =
      'https://kazuha.zeabur.app/webhook/FEARLESS - Railway API' +
      `?origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}`;

    const res = await fetch(url);

    if (!res.ok) {
      throw new Error('HTTP ' + res.status);
    }

    const data = await res.json();

    if (!data.ok) {
      // ä¾‹å¦‚ ZERO_RESULTS çš„æƒ…æ³æœƒèµ°åˆ°é€™è£¡
      alert(data.message || 'æŸ¥ä¸åˆ°è·¯ç·šè³‡è¨Šï¼Œè«‹æ”¹ç”¨ Google Maps æŸ¥çœ‹è©³ç´°è·¯ç·šèˆ‡æ™‚é–“');
      return;
    }

    railwayResults.time = data.time || 'â€”';
    railwayResults.fare = data.fare ?? null;
    railwayResults.transfers = data.transfers ?? 0;
  } catch (error) {
    console.error(error);
    alert('è·¯ç·šæŸ¥è©¢æœå‹™æš«æ™‚æœ‰é»ç‹€æ³ï¼Œç­‰ç­‰å†è©¦è©¦çœ‹å–”ï½');
  } finally {
    isLoadingRailway.value = false;
  }
};


        const openTransitMap = () => {
          const origin = encodeURIComponent(
            railwayOrigin.value.trim() + " Japan"
          );
          const destination = encodeURIComponent(
            railwayDestination.value.trim() + " Japan"
          );
          const mapUrl = `https://www.google.com/maps/dir/${origin}/${destination}/data=!4m2!4m1!3e3`;
          window.open(mapUrl, "_blank");
        };

        // --- å¤©æ°£åŠŸèƒ½é‚è¼¯ (Weather Logic) ---
const weatherQuery = ref('æ±äº¬');
const isLoadingWeather = ref(false);
const weatherResult = reactive({
  city: '',
  date: '',
  temperature: '',
  description: '',
  humidity: '',
  windSpeed: '',
  maxTemp: '',
  minTemp: '',
  iconClass: 'fas fa-question-circle'
});

// âš ï¸ è¨˜å¾—æŠŠèˆŠçš„ mockData å’Œ setTimeout é‚£æ®µæ•´å€‹åˆªæ‰ï¼Œåªç•™é€™å€‹æ–°ç‰ˆå‡½å¼
const getWeather = async () => {
  const query = weatherQuery.value.trim();
  if (!query) return;

  isLoadingWeather.value = true;

  // å…ˆæ¸…ç©ºç•«é¢
  Object.assign(weatherResult, {
    city: '',
    date: '',
    temperature: '',
    description: '',
    humidity: '',
    windSpeed: '',
    maxTemp: '',
    minTemp: '',
    iconClass: 'fas fa-question-circle'
  });

  try {
    // æ›æˆä½ çš„ n8nã€ŒProduction URLã€
    const res = await fetch(
      `https://kazuha.zeabur.app/webhook/fearless-weather?city=${encodeURIComponent(query)}`
    );

    if (!res.ok) {
      throw new Error('HTTP ' + res.status);
    }

    const data = await res.json();

    if (!data.ok) {
      alert(data.message || 'æŸ¥ä¸åˆ°å¤©æ°£è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ä¸€æ¬¡');
      return;
    }

    Object.assign(weatherResult, {
      city: data.city || query,
      date: new Date().toLocaleDateString('zh-TW', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      }),
      temperature: data.temperature,
      description: data.description,
      humidity: data.humidity,
      windSpeed: data.windSpeed,
      maxTemp: data.maxTemp,
      minTemp: data.minTemp,
      iconClass: data.iconClass || 'fas fa-question-circle'
    });
  } catch (error) {
    console.error(error);
    alert('å¤©æ°£æœå‹™æš«æ™‚æœ‰é»å•é¡Œï¼Œç­‰ç­‰å†è©¦è©¦çœ‹å”·ï½');
  } finally {
    isLoadingWeather.value = false;
  }
};

// é è¨­é€²ä¾†å°±å¹«ä½ æŸ¥ä¸€æ¬¡æ±äº¬
getWeather();


        // ----- åœ°åœ– -----
        const mapQuery = ref("æ¾€è°·äº¤å‰è·¯å£");
        const mapPresets = [
          "æ¾€è°·äº¤å‰è·¯å£",
          "æ±äº¬è»Šç«™",
          "é“é “å €",
          "æ¸…æ°´å¯º",
        ];

        const openMap = () => {
          if (mapQuery.value.trim()) {
            const query = encodeURIComponent(
              mapQuery.value.trim() + " Japan"
            );
            const mapUrl = `https://www.google.com/maps/search/?api=1&query=${query}`;
            window.open(mapUrl, "_blank");
          }
        };

        return {
          currentTab,
          tabs,

          dailySchedule,
          newActivity,
          sortedSchedule,
          addActivity,
          deleteActivity,
          toggleEdit,

          people,
          newPersonName,
          expenses,
          newExpense,
          addPerson,
          removePerson,
          addExpense,
          settlements,
          totalExpense,
          averageExpensePerPerson,

          railwayOrigin,
          railwayDestination,
          isLoadingRailway,
          railwayResults,
          searchRailway,
          openTransitMap,

          weatherQuery,
          isLoadingWeather,
          weatherResult,
          getWeather,

          mapQuery,
          mapPresets,
          openMap,
        };
      },
    }).mount("#app");
  </script>
</body>
</html>
